From 19cb837a0897c40b328f1c2fdf29253fbde0469f Mon Sep 17 00:00:00 2001
From: Jonathan King <jonathan.j.king@gmail.com>
Date: Wed, 23 Aug 2017 13:33:24 +0100
Subject: [PATCH 1/4] change make-patch to fit my workflow

---
 make-patch.sh | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/make-patch.sh b/make-patch.sh
index a6bed0d..42a6ddf 100755
--- a/make-patch.sh
+++ b/make-patch.sh
@@ -1 +1 @@
-git format-patch 37300b34c92ab7b5312e2e8d7cfbba15784a0f5b..HEAD --stdout > changes.patch
+git format-patch 37301b34c92ab7b5312e2e8d7cfbba15784a0f5b..HEAD --stdout > ../flow-bin/changes.patch
-- 
2.9.3 (Apple Git-75)


From 72ea64662eae9fead48155b84d9a91cce497c61b Mon Sep 17 00:00:00 2001
From: Jonathan King <JonathanUsername@users.noreply.github.com>
Date: Wed, 23 Aug 2017 13:39:50 +0100
Subject: [PATCH 2/4] Update README.md

---
 README.md | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/README.md b/README.md
index ef9ff86..c4e81db 100644
--- a/README.md
+++ b/README.md
@@ -1,3 +1,8 @@
+NB: For future Jon - Just use this for creating the changes.patch file that is then applied in the flow-bin repo.
+
+Go to the branch/release you want, try to apply the standard patch, if it conflicts, overwrite the old one in flow-bin, then run the build script.
+
+
 # Flow [![Build Status](https://travis-ci.org/facebook/flow.svg?branch=master)](https://travis-ci.org/facebook/flow) [![Windows Build Status](https://ci.appveyor.com/api/projects/status/thyvx6i5nixtoocm/branch/master?svg=true)](https://ci.appveyor.com/project/Facebook/flow/branch/master)
 
 Flow is a static typechecker for JavaScript. To find out more about Flow, check out [flow.org](https://flow.org/).
-- 
2.9.3 (Apple Git-75)


From f1ce384cde11e55b1ceccf8f8e48675405b94ec5 Mon Sep 17 00:00:00 2001
From: Jonathan King <jonathan.j.king@gmail.com>
Date: Thu, 24 Aug 2017 16:53:40 +0100
Subject: [PATCH 3/4] Don't add error to suppressed errors if file is
 suppressed

---
 src/typing/type_inference_js.ml | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/typing/type_inference_js.ml b/src/typing/type_inference_js.ml
index 9a4a555..014a665 100644
--- a/src/typing/type_inference_js.ml
+++ b/src/typing/type_inference_js.ml
@@ -15,6 +15,8 @@ module FlowError = Flow_error
 module ImpExp = Import_export
 module Utils = Utils_js
 
+open Sys
+
 (**********)
 (* Driver *)
 (**********)
@@ -42,23 +44,31 @@ let infer_core cx statements =
     let loc = Loc.({ none with source = Some (Context.file cx) }) in
     Flow_js.add_output cx FlowError.(EInternal (loc, UncaughtException exc))
 
+let whitelist_env = try getenv "FLOW_WHITELIST" with Not_found -> "";;
+let whitelist_re_list = if whitelist_env = "" then [] else Str.split (Str.regexp "++") whitelist_env;;
+let matches_whitelist_elem s1 s2 =
+    let re = Str.regexp s2
+    in
+        try ignore (Str.search_forward re s1 0); true
+        with Not_found -> false;;
 (* There's a .flowconfig option to specify suppress_comments regexes. Any
  * comments that match those regexes will suppress any errors on the next line
  *)
 let scan_for_error_suppressions =
-  let should_suppress suppress_comments comment =
+  let should_suppress suppress_comments comment  =
     List.exists (fun r -> Str.string_match r comment 0) suppress_comments
 
   in fun cx comments ->
     let suppress_comments = Context.suppress_comments cx in
     let should_suppress = should_suppress suppress_comments in
+    let in_whitelist (loc: Loc.t) = List.exists (fun e -> matches_whitelist_elem (Loc.to_string loc) e) whitelist_re_list in
 
     (* Bail immediately if we're not using error suppressing comments *)
     if suppress_comments <> []
     then List.iter (function
       | loc, Ast.Comment.Block comment
       | loc, Ast.Comment.Line comment when should_suppress comment ->
-          Context.add_error_suppression cx loc
+          if not (in_whitelist loc) then Context.add_error_suppression cx loc else ()
       | _ -> ()) comments
 
 type 'a located = {
-- 
2.9.3 (Apple Git-75)


From 005ad3e30a492d89b306ef297eae75f113a7f89a Mon Sep 17 00:00:00 2001
From: Jonathan King <jonathan.j.king@gmail.com>
Date: Thu, 24 Aug 2017 16:53:40 +0100
Subject: [PATCH 4/4] Fix filenames

---
 src/typing/type_inference_js.ml | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/src/typing/type_inference_js.ml b/src/typing/type_inference_js.ml
index 014a665..531a149 100644
--- a/src/typing/type_inference_js.ml
+++ b/src/typing/type_inference_js.ml
@@ -61,14 +61,15 @@ let scan_for_error_suppressions =
   in fun cx comments ->
     let suppress_comments = Context.suppress_comments cx in
     let should_suppress = should_suppress suppress_comments in
-    let in_whitelist (loc: Loc.t) = List.exists (fun e -> matches_whitelist_elem (Loc.to_string loc) e) whitelist_re_list in
+    let in_whitelist f = List.exists (fun e -> matches_whitelist_elem f e) whitelist_re_list in
 
     (* Bail immediately if we're not using error suppressing comments *)
     if suppress_comments <> []
     then List.iter (function
       | loc, Ast.Comment.Block comment
-      | loc, Ast.Comment.Line comment when should_suppress comment ->
-          if not (in_whitelist loc) then Context.add_error_suppression cx loc else ()
+      | (loc: Loc.t), Ast.Comment.Line comment when should_suppress comment ->
+          let filename = Loc.string_of_filename (Context.file cx) in
+          if not (in_whitelist filename) then Context.add_error_suppression cx loc else ()
       | _ -> ()) comments
 
 type 'a located = {
-- 
2.9.3 (Apple Git-75)

